# docker image that is used for all ci jobs; see https://hub.docker.com/ for a list of valid docker images
# Image with the centos 7 compilers
# image: iffregistry.fz-juelich.de/docker-images/centos7-intel-compilers/extended
# image: iffregistry.fz-juelich.de/docker-images/centos8-intel-compilers:latest
image: iffregistry.fz-juelich.de/docker-images/centos8-intel-compilers:latest-ipython3
# list with commands that are executed before each job; every job starts with a fresh docker container
before_script:
  - echo before scripts
  - set +e && source compilervars.sh intel64 && set -e
  - which ifort
  - ifort --version
  - which mpiifort
  - mpiifort -v
  # - pip3 install --user numpy

# pipeline stages; a stage is only run if the previous stage is completed. Each stage contains user-defined jobs
# that are run in parallel
stages:
  - build
  - test_results
  - test_supercond
  # - test_runtime
#   # - deploy:doc
#
# a build job (see `stage` key); jobs can have arbitrary names
build:intel:debug:
  stage: build
  script:
    - cd build
    - cmake ../ -DPLATFORM=iff -DDEBUG=ON
    - make 2> >(tee make.warnings)
    - test ! -s make.warnings
  artifacts:
    paths:
      - make.warnings
      - bin/
    expire_in: 1 day
  allow_failure: true

build:gnu:normal:
  stage: build
  script:
    - cd build
    - cmake ../ -DPLATFORM=iff -DCOMPILER=gnu
    - make
  artifacts:
    paths:
      - bin/
    expire_in: 1 day

build:gnu:debug:
  stage: build
  script:
    - cd build
    - cmake ../ -DPLATFORM=iff -DCOMPILER=gnu -DDEBUG=ON
    - make 2> >(tee make.warnings)
    - test ! -s make.warnings
  artifacts:
    paths:
      - make.warnings
      - bin/
    expire_in: 1 day
  allow_failure: true

build:intel:normal:
  stage: build
  script:
    - cd build
    - cmake ../ -DPLATFORM=iff
    - make
  artifacts:
    paths:
      - bin/
    expire_in: 1 day

.run_test: &run_test
    - python --version
    - cd ${TEST_FOLDER}
    - export OMP_NUM_THREADS=4
    - mpirun -np 2 ../../bin/titan_iff.exe
    - grep "Finished on" output/*

.compare_files: &compare_files |
    for file in `find results/ -type f`
    do
      echo "Comparing file $(basename ${file}) with tolerance ${TOL}"
      python ../../scripts/compare_output.py ${file} ${file/results/results_correct} ${TOL}
    done

# after build job(s) are completed, tests can be run; artifacts from all previous stages are transferred automatically
test:monolayer:
  image: iffregistry.fz-juelich.de/docker-images/centos7-intel-compilers/slurm-daemon:latest
  stage: test_results
  needs: ["build:intel:normal"]
  script:
    - export TEST_FOLDER="examples/Nb_100_Monolayer"
    - *run_test
    - *compare_files

test:timeprop:
  image: iffregistry.fz-juelich.de/docker-images/centos7-intel-compilers/slurm-daemon:latest
  stage: test_results
  needs: ["build:intel:normal"]
  script:
    - export TEST_FOLDER="examples/Ni_bulk_timeprop"
    - *run_test
    - export TOL="1.e-7"
    - *compare_files

test:supercond:
  image: iffregistry.fz-juelich.de/docker-images/centos7-intel-compilers/slurm-daemon:latest
  stage: test_supercond
  needs: ["build:intel:normal","test:monolayer"]
  script:
    - export TEST_FOLDER="examples/Nb_100_Superconducting_Monolayer"
    - *run_test
    - export TOL="1.e-7"
    - *compare_files

test:bands:
  image: iffregistry.fz-juelich.de/docker-images/centos7-intel-compilers/slurm-daemon:latest
  stage: test_supercond
  needs: ["build:intel:normal","test:monolayer"]
  script:
    - export TEST_FOLDER="examples/Nb_100_Monolayer"
    - sed -i 's/-> itype = 1/-> itype = 2/g' input
    - sed -i 's/-> skipsc = F/-> skipsc = T/g' input
    - *run_test
    - export TOL="1.e-7"
    - *compare_files



# # `pages` is a special job that builds the gitlab page for this project; all artifacts must be saved in a `public`
# # directory to be published as a static site (that can be accessed from the whole www)
# pages:
#   stage: deploy:doc
#   script:
#     - apt install -y ffmpeg python-pip
#     # ubuntu ships with an old pip version -> upgrade before python packages are installed via pip
#     - pip install -U pip
#     # install sphinx (documentation generator) from PyPI to get the latest stable version
#     - pip install sphinx sphinx_rtd_theme
#     - make doc
#     - mv doc/_build/html/ public/
#   artifacts:
#     paths:
#       - public
#   # only publish a new site if commits are pushed to the master branch -> stable release
#   only:
#     - master
